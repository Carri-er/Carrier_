<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<div th:replace="~{head/head::head}"></div>

<body>

<div th:replace="~{nav/nav::nav}"></div>
    <div class="map_wrapp">
        <!-- 맵 컨텐츠 전체를 감싸는 영역  -->
        <div class="map_all_contentBox">
            <!-- map 왼쪽 가이드 영역 -->
            <div class="map_guide">
                <!-- gps 현재 위치 출력 영역 -->
                <div class="map_curr_locationBox">
                    <div class="col map_curr_location d-flex justify-content-between">
                        <div class="map_curr_location_name">
                            <span>경기 수원시 권선구</span>
                        </div>
                        <div class="map_curr_location_weather d-flex">
                            <span>현재날씨 </span>
                            <em>최고 | 최저</em>
                        </div>
                    </div>
                </div>  <!-- map_curr_locationBox -->

                <!-- map guide 아이콘 영역 -->
                <div class="map_guide_iconBox">
                    <div class="map_guide_icon">
                        <ul class="map_guide_icon_list px-0">
                            <li class="map_guide_icon_item map_icon_near_trip">
                                주변여행지
                            </li>
                            <li class="map_guide_icon_item map_icon_food">
                                음식점
                            </li>
                            <li class="map_guide_icon_item map_icon_cafe">
                                카페
                            </li>
                            <li class="map_guide_icon_item map_icon_hotel">
                                숙소
                            </li>
                            <li class="map_guide_icon_item map_icon_park">
                                주차장
                            </li>
                            <li class="map_guide_icon_item map_icon_electric_charg">
                                전기차충전소
                            </li>
                            <li class="map_guide_icon_item map_icon_recomand_thema">
                                추천테마
                            </li>
                            <li class="map_guide_icon_item map_icon_trip_course">
                                여행코스
                            </li>
                            <li class="map_guide_icon_item map_icon_myTrip">
                                나의여행
                            </li>
                            <li class="map_guide_icon_item map_icon_set">
                                설정
                            </li>
                        </ul>
                    </div>
                  
                </div> <!-- map_guide_iconBox 끝 div--> 
                
                <!-- pagination -->
                <div class="pagination"></div>					
                <div class="mapListItemBox">
                	<div id="distanceListContainer"></div>	
                </div>
            </div> <!-- map_guide -->

            <div class="map_mapSection">
                <!-- 지도를 표시할 div 입니다 -->
                <div id="map"></div>
            </div>
        </div>
        
    </div>

<div th:replace="~{footer/footer::footer}"></div>
<!-- JavaScript section -->
<script th:inline="javascript">

    /*<![CDATA[*/
    kakao.maps.load(function () {
    	
    	var offset = 0; // 데이터 오프셋
        var limit = 20; // 한 번에 로드할 데이터 수
        
        // Initialize variables
        var markers = [];
        var distances = [];
        var mapMarkerList = /*[[${mapMarkerList}]]*/ [];
        var presentPosition;
        var combinedData = [];

        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(37.566826, 126.9786567), // 서울
            level: 5
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);

        mapMarkerList.forEach(function (markerInfo) {
            var markerPosition = new kakao.maps.LatLng(parseFloat(markerInfo.event_mapX), parseFloat(markerInfo.event_mapY));
            var marker = new kakao.maps.Marker({
                position: markerPosition
            });
            marker.setMap(map);
            markers.push(marker);
            addMarkerClickListener(marker, markers.length - 1);
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var lat = position.coords.latitude;
                var lon = position.coords.longitude;
                presentPosition = new kakao.maps.LatLng(lat, lon);
                var currentPositionMarker = new kakao.maps.Marker({
                    position: presentPosition,
                    map: map
                });
                markers.push(currentPositionMarker);
                map.setCenter(presentPosition);
                calculateDistances(presentPosition, markers);
            });
        } else {
            presentPosition = new kakao.maps.LatLng(37.566826, 126.9786567); // 서울
            alert('현재 위치를 찾을 수 없습니다');
            var currentPositionMarker = new kakao.maps.Marker({
                position: presentPosition,
                map: map
            });
            markers.push(currentPositionMarker);
            map.setCenter(presentPosition);
            calculateDistances(presentPosition, markers);
        }

        function addMarkerClickListener(marker, index) {
            kakao.maps.event.addListener(marker, 'click', function () {
                var event = mapMarkerList[index];
                var markerPosition = marker.getPosition();
                var distance = getDistance(presentPosition, markerPosition);
                var eventName = event.event_name;
                var eventNum = event.event_num;
                var info = "거리: " + distance.toFixed(2) + "m, 이벤트 이름: " + eventName + " (" + eventNum + ")";
                alert(info);
            });
        }

        function calculateDistances(presentPosition, markers) {
            markers.forEach(function (marker) {
                var distance = getDistance(presentPosition, marker.getPosition());
                distances.push(distance);
            });

            var combinedData = distances.map(function (distance, index) {
                return {
                    distance: distance,
                    event: mapMarkerList[index],
                };
            });
            console.log(combinedData);
            sendDataToServer(combinedData);
        }

        function sendDataToServer(data) {
            if (data && data.length > 0) {
            	
            	var requestData = {
                        data: data,
                        offset: offset,
                        limit: limit
                    };
            	
                $.ajax({
                    url: '/getDistance',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(requestData),
                    success: function (response) {
                        displayDistanceList(response);
                    },
                    error: function (xhr, status, error) {
                        console.error('서버 요청 실패:', error);
                    }
                });
            } else {
                console.log('전송할 데이터가 없습니다.');
            }
        }

        function displayDistanceList(distanceList) {
            var html = "<div class='mapListItem row'>";
            var itemsPerPage = 20;
            var startIndex = (currentPage - 1) * itemsPerPage;
            var endIndex = Math.min(startIndex + itemsPerPage, distanceList.length);

            for (var i = startIndex; i < endIndex; i++) {
                var item = distanceList[i];
                html += "<a class='row' href='Event_view?id=" + item.event.event_num + "'>";
                html += "<div class='col-3 board-left text-center hstack justify-content-center'>";
                html += "<img src='../img/info/" + item.event.event_thumbnail + "' class='img-fluid rounded-4' alt='' style='width: 80px; height: 80px;'>";
                html += "</div>";
                html += "<div class='col'>";
                html += "<div class='row'>";
                html += "<div class='col'>";
                html += "<h6>[<span>" + item.event.event_category + "</span>] <span>" + item.event.event_name + "</span></h6>";
                html += "</div>";
                html += "</div>";
                html += "</div>";
                html += "</a>";
            }
            html += "</div>";
            $('#distanceListContainer').append(html);

            offset += limit;
        }


        function getDistance(p1, p2) {
            var lat1 = p1.getLat(), lon1 = p1.getLng();
            var lat2 = p2.getLat(), lon2 = p2.getLng();
            var R = 6371000;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLon = (lon2 - lon1) * Math.PI / 180;
            var a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            var d = R * c;
            return d;
        }
        
        // 스크롤 이벤트 리스너
        $('#distanceListContainer').scroll(function () {
            // 스크롤이 맨 아래에 도달하면 추가 데이터 로드
            if ($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
                var offset = $('.mapListItem').length; // 현재 로드된 아이템 수를 오프셋으로 설정
                loadMoreData(offset, limit); 
            }
        });
        
        // 추가 데이터 로드 함수
        function loadMoreData(offset, limit) {
            var data = {
                offset: offset,
                limit: limit
            };
            
            $.ajax({
                url: '/getDistance',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function (response) {
                    displayDistanceList(response);
                },
                error: function (xhr, status, error) {
                    console.error('서버 요청 실패:', error);
                }
            });
        }
        
        
    });
    /*]]>*/
</script>
</body>

</html>